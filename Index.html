<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StyleWave — Fashion 3D Store</title>
  <meta name="description" content="Colorful, mobile-first fashion store with 3D preview and email order notifications" />
  <style>
  :root{
    --bg1:#ffecd2; --bg2:#fcb69f; --accent:#6c63ff; --muted:#666;
    --card-shadow: 0 8px 24px rgba(12,12,45,0.12); --glass: rgba(255,255,255,0.6);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh;
    background: linear-gradient(135deg,var(--bg1),var(--bg2));
    color:#111; -webkit-font-smoothing:antialiased; padding-bottom:64px;
  }
  .site-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;
    background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    backdrop-filter: blur(6px);
  }
  .logo{font-size:1.25rem;font-weight:700;color:var(--accent)}
  .header-actions{display:flex;gap:10px;align-items:center}
  .header-actions input{padding:8px 12px;border-radius:10px;border:0;min-width:160px;box-shadow:var(--card-shadow)}
  .hero{text-align:center;padding:28px 16px}
  .controls{display:flex;gap:12px;padding:12px 16px;align-items:center}
  .controls button, .controls select{padding:8px 12px;border-radius:10px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  .products-grid{display:grid;gap:14px;padding:14px;grid-template-columns: repeat(2, 1fr)}
  @media(min-width:700px){ .products-grid{ grid-template-columns: repeat(3, 1fr); } }
  @media(min-width:1000px){ .products-grid{ grid-template-columns: repeat(4, 1fr); } }
  .card{background: linear-gradient(180deg, rgba(255,255,255,0.95), var(--glass));border-radius:14px;padding:12px;box-shadow:var(--card-shadow);
    transform-style:preserve-3d;transition: transform .18s ease, box-shadow .18s ease;cursor:pointer;display:flex;flex-direction:column;gap:8px;
  }
  .card:hover{ transform: translateY(-6px) rotateX(2deg) rotateY(-2deg); }
  .card .img{width:100%;height:220px;border-radius:10px;overflow:hidden;background-size:cover;background-position:center}
  .card h4{margin:0;font-size:1rem}
  .meta{display:flex;justify-content:space-between;align-items:center}
  .price{color:var(--accent);font-weight:700}
  .btn-inline{background:var(--accent);color:#fff;border-radius:8px;padding:8px 10px;border:0;cursor:pointer}
  .panel{position:fixed;right:12px;top:80px;width:320px;background:#fff;border-radius:12px;padding:12px;box-shadow:var(--card-shadow);z-index:80}
  .hidden{display:none}
  .panel .close{float:right;border:0;background:transparent;font-size:20px}
  .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,0.45),rgba(0,0,0,0.6));z-index:90}
  .modal .close{position:absolute;right:18px;top:18px;border:0;background:transparent;color:#fff;font-size:28px}
  .viewer-inner, .admin-inner{position:relative;background:#fff;padding:12px;border-radius:12px;max-width:920px;width:92%;max-height:92vh;overflow:auto;display:flex;gap:12px}
  #viewer-content{flex:1;height:60vh;border-radius:8px;overflow:hidden;background:#fafafa;display:flex;align-items:center;justify-content:center}
  .viewer-info{width:260px;display:flex;flex-direction:column;gap:8px}
  label{display:block;margin:8px 0}
  input, select, textarea{padding:8px;border-radius:8px;border:1px solid #eee;width:100%}
  .small-muted{font-size:0.85rem;color:var(--muted)}
  </style>
</head>
<body>
  <header class="site-header">
    <div class="logo">StyleWave</div>
    <div class="header-actions">
      <input id="search" placeholder="Search styles, e.g., jacket" />
      <button id="cart-btn" class="btn-inline">Cart (<span id="cart-count">0</span>)</button>
    </div>
  </header>

  <main>
    <section class="hero">
      <h1>Colorful. Mobile-first. 3D.</h1>
      <p class="small-muted">Shop trendy fashion items with interactive 3D previews — fast and beautiful on mobile.</p>
    </section>

    <section class="controls">
      <button id="open-admin" class="btn-inline">Admin</button>
      <select id="sort">
        <option value="featured">Featured</option>
        <option value="price-asc">Price: low → high</option>
        <option value="price-desc">Price: high → low</option>
      </select>
    </section>

    <section id="products" class="products-grid" aria-live="polite"></section>
  </main>

  <!-- Cart panel -->
  <aside id="cart-panel" class="panel hidden">
    <button class="close">×</button>
    <h2>Your Cart</h2>
    <div id="cart-items"></div>
    <div class="cart-footer" style="margin-top:12px">
      <div>Total: <strong id="cart-total">$0.00</strong></div>
      <button id="open-checkout" class="btn-inline" style="margin-top:8px">Checkout</button>
    </div>
  </aside>

  <!-- Checkout modal -->
  <div id="checkout-modal" class="modal hidden">
    <div class="viewer-inner">
      <button class="close">×</button>
      <div style="flex:1;max-width:760px">
        <h2>Checkout</h2>
        <form id="checkout-form">
          <label>Name<input name="name" required /></label>
          <label>Email<input name="email" type="email" required /></label>
          <label>Phone<input name="phone" required /></label>
          <label>Address<textarea name="address" rows="3" required></textarea></label>
          <div style="display:flex;gap:8px;margin-top:12px">
            <button type="submit" class="btn-inline">Place order</button>
            <button type="button" id="cancel-checkout">Cancel</button>
          </div>
          <small class="small-muted">This demo writes orders to Firestore and triggers an email to the owner (via Cloud Function).</small>
        </form>
      </div>
    </div>
  </div>

  <!-- Product viewer modal (image or 3D) -->
  <div id="viewer" class="modal hidden">
    <div class="viewer-inner">
      <button class="close">×</button>
      <div id="viewer-content"></div>
      <div class="viewer-info">
        <h3 id="viewer-title"></h3>
        <div id="viewer-price"></div>
        <button id="viewer-add" class="btn-inline">Add to cart</button>
      </div>
    </div>
  </div>

  <!-- Admin modal -->
  <div id="admin" class="modal hidden">
    <div class="admin-inner">
      <button class="close">×</button>
      <div style="flex:1;max-width:760px">
        <h2>Add product</h2>
        <form id="admin-form">
          <label>Title<input name="title" required /></label>
          <label>Price<input name="price" type="number" step="0.01" required /></label>
          <label>Image file (or use Image URL)<input name="imageFile" type="file" accept="image/*" /></label>
          <label>Image URL<input name="imageUrl" placeholder="https://..." /></label>
          <label>3D model file (.glb/.gltf) <input name="modelFile" type="file" accept=".gltf,.glb" /></label>
          <label>Or 3D model URL<input name="modelUrl" placeholder="https://..." /></label>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button type="submit" class="btn-inline">Save product</button>
            <button type="button" id="admin-close">Cancel</button>
          </div>
          <small class="small-muted">Secure this admin UI in production (Firebase Auth + roles).</small>
        </form>
      </div>
    </div>
  </div>

  <!-- Load libraries -->
  <script type="module">
  // --- CONFIGURATION: replace with your Firebase project config ---
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };
  // ----------------------------------------------------------------

  // import firebase modular SDK from CDN
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
  import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';
  import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js';

  // three.js + GLTFLoader
  import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';
  import { GLTFLoader } from 'https://unpkg.com/three@0.152.2/examples/jsm/loaders/GLTFLoader.js';

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // UI refs
  const productsEl = document.getElementById('products');
  const cartCountEl = document.getElementById('cart-count');
  const cartPanel = document.getElementById('cart-panel');
  const cartItemsEl = document.getElementById('cart-items');
  const cartTotalEl = document.getElementById('cart-total');
  const viewer = document.getElementById('viewer');
  const viewerContent = document.getElementById('viewer-content');
  const viewerTitle = document.getElementById('viewer-title');
  const viewerPrice = document.getElementById('viewer-price');
  const viewerAdd = document.getElementById('viewer-add');
  const adminModal = document.getElementById('admin');
  const checkoutModal = document.getElementById('checkout-modal');

  // Cart (localStorage)
  const CART_KEY = 'fashion_cart_v1';
  let cart = JSON.parse(localStorage.getItem(CART_KEY)||'[]');
  function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); updateCartUI(); }
  function updateCartUI(){
    const count = cart.reduce((s,i)=>s+i.qty,0);
    cartCountEl.textContent = count;
    cartItemsEl.innerHTML = cart.length ? cart.map(ci=>`
      <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f1f1f1">
        <div>${ci.title} x ${ci.qty}</div>
        <div>$${(ci.price*ci.qty).toFixed(2)} <button data-id="${ci.id}" class="remove small-muted" style="margin-left:8px">remove</button></div>
      </div>
    `).join('') : '<div>Your cart is empty</div>';
    cartTotalEl.textContent = '$' + cart.reduce((s,i)=>s+i.price*i.qty,0).toFixed(2);
  }
  updateCartUI();

  // Fetch products realtime from Firestore
  const productsCol = collection(db, 'products');
  const productsQuery = query(productsCol, orderBy('createdAt', 'desc'));
  let products = [];
  onSnapshot(productsQuery, snap => {
    products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderProducts(products);
  });

  function renderProducts(list){
    productsEl.innerHTML = list.map(p=>{
      const img = p.imageUrl || '';
      return `<article class="card" data-id="${p.id}">
        <div class="img" style="background-image:url('${img}')"></div>
        <h4>${escapeHtml(p.title)}</h4>
        <div class="meta">
          <div class="price">$${Number(p.price).toFixed(2)}</div>
          <div>
            <button class="btn-inline view">View</button>
            <button class="btn-inline add">Add</button>
          </div>
        </div>
      </article>`;
    }).join('');
  }

  // Click handlers for product grid
  productsEl.addEventListener('click', (e)=>{
    const card = e.target.closest('.card');
    if(!card) return;
    const id = card.dataset.id;
    const p = products.find(x=>x.id===id);
    if(e.target.classList.contains('add')) addToCart(p);
    if(e.target.classList.contains('view')) openViewer(p);
  });

  function addToCart(product){
    const exist = cart.find(c=>c.id===product.id);
    if(exist) exist.qty++;
    else cart.push({ id:product.id, title:product.title, price:Number(product.price), qty:1 });
    saveCart();
    cartPanel.classList.remove('hidden');
  }

  // Cart panel events
  document.getElementById('cart-btn').addEventListener('click', ()=>cartPanel.classList.toggle('hidden'));
  cartPanel.addEventListener('click', e=>{
    if(e.target.classList.contains('close')) cartPanel.classList.add('hidden');
    if(e.target.classList.contains('remove')){
      const id = e.target.dataset.id;
      cart = cart.filter(c=>c.id!==id);
      saveCart();
    }
  });

  // Checkout
  document.getElementById('open-checkout').addEventListener('click', ()=> {
    if(!cart.length){ alert('Cart empty'); return; }
    checkoutModal.classList.remove('hidden');
  });
  document.getElementById('cancel-checkout').addEventListener('click', ()=> checkoutModal.classList.add('hidden'));
  document.getElementById('checkout-form').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const fd = new FormData(ev.target);
    const customer = {
      name: fd.get('name'), email: fd.get('email'), phone: fd.get('phone'), address: fd.get('address')
    };
    const order = {
      items: cart.map(ci=>({ id:ci.id, title:ci.title, price:ci.price, qty:ci.qty })),
      total: Number(cart.reduce((s,i)=>s+i.price*i.qty,0).toFixed(2)),
      customer,
      status: 'new',
      createdAt: serverTimestamp()
    };
    try {
      // write to Firestore orders collection
      const ordersCol = collection(db, 'orders');
      const docRef = await addDoc(ordersCol, order);
      alert('Order placed! Order ID: ' + docRef.id + '\nYou will receive confirmation by email.');
      cart = []; saveCart();
      checkoutModal.classList.add('hidden');
    } catch(err){
      console.error(err);
      alert('Order failed: ' + err.message);
    }
  });

  // Viewer (image or 3D)
  async function openViewer(product){
    viewerTitle.textContent = product.title;
    viewerPrice.textContent = '$' + Number(product.price).toFixed(2);
    viewerAdd.onclick = ()=> addToCart(product);
    viewer.classList.remove('hidden');
    viewerContent.innerHTML = '';
    viewerContent.style.backgroundImage = '';
    if(product.modelUrl){
      // three.js scene
      const scene = new THREE.Scene();
      const canvas = document.createElement('canvas');
      viewerContent.appendChild(canvas);
      const width = viewerContent.clientWidth || 640;
      const height = viewerContent.clientHeight || 480;
      const renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:true});
      renderer.setSize(width, height, false);
      const camera = new THREE.PerspectiveCamera(35, width/height, 0.1, 1000);
      camera.position.set(0, 0.5, 2);
      const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2); scene.add(hemi);
      const dir = new THREE.DirectionalLight(0xffffff, 0.6); dir.position.set(3,10,4); scene.add(dir);
      const loader = new GLTFLoader();
      try {
        const gltf = await loader.loadAsync(product.modelUrl);
        scene.add(gltf.scene);
        // auto center & scale
        const box = new THREE.Box3().setFromObject(gltf.scene);
        const size = box.getSize(new THREE.Vector3()).length();
        const center = box.getCenter(new THREE.Vector3());
        gltf.scene.position.x += (gltf.scene.position.x - center.x);
        gltf.scene.position.y += (gltf.scene.position.y - center.y);
        gltf.scene.position.z += (gltf.scene.position.z - center.z);
        const dist = size * 1.8;
        camera.position.set(0, size*0.2, dist);
      } catch(err){
        viewerContent.innerHTML = '<div style="padding:20px">Failed to load 3D model. Showing image instead.</div>';
        viewerContent.style.backgroundImage = `url('${product.imageUrl}')`;
        viewerContent.style.backgroundSize = 'cover';
      }
      let stopped = false;
      function animate(){ if(stopped) return; requestAnimationFrame(animate); scene.rotation && (scene.rotation.y += 0.008); renderer.render(scene, camera); }
      animate();
      viewerContent._cleanup = ()=>{ stopped = true; renderer.dispose(); };
    } else {
      viewerContent.style.backgroundImage = `url('${product.imageUrl}')`;
      viewerContent.style.backgroundSize = 'cover';
    }
  }

  viewer.addEventListener('click', (e)=> {
    if(e.target.classList.contains('close') || e.target === viewer){
      if(viewerContent._cleanup) viewerContent._cleanup();
      viewerContent.innerHTML = '';
      viewerContent.style.backgroundImage = '';
      viewer.classList.add('hidden');
    }
  });

  // Admin create product (uploads to Storage then writes product doc)
  document.getElementById('open-admin').addEventListener('click', ()=> adminModal.classList.remove('hidden'));
  adminModal.addEventListener('click', (e)=> { if(e.target.classList.contains('close') || e.target === adminModal) adminModal.classList.add('hidden'); });
  document.getElementById('admin-close').addEventListener('click', ()=> adminModal.classList.add('hidden'));

  document.getElementById('admin-form').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const f = ev.target;
    const title = f.title.value.trim();
    const price = Number(f.price.value);
    const imageFile = f.imageFile.files[0];
    const imageUrlField = f.imageUrl.value.trim();
    const modelFile = f.modelFile.files[0];
    const modelUrlField = f.modelUrl.value.trim();

    if(!title || !price || (!imageFile && !imageUrlField)){ alert('Please provide title, price, and an image (file or URL).'); return; }

    try {
      // show saving UI (simple)
      f.querySelector('button[type="submit"]').textContent = 'Saving...'; f.querySelector('button[type="submit"]').disabled = true;

      let finalImageUrl = imageUrlField || '';
      let finalModelUrl = modelUrlField || '';

      if(imageFile){
        const imRef = storageRef(storage, `products/images/${Date.now()}_${imageFile.name}`);
        await uploadBytes(imRef, imageFile);
        finalImageUrl = await getDownloadURL(imRef);
      }
      if(modelFile){
        const mRef = storageRef(storage, `products/models/${Date.now()}_${modelFile.name}`);
        await uploadBytes(mRef, modelFile);
        finalModelUrl = await getDownloadURL(mRef);
      }

      // write product doc
      await addDoc(collection(db, 'products'), {
        title,
        price,
        imageUrl: finalImageUrl,
        modelUrl: finalModelUrl || '',
        createdAt: serverTimestamp()
      });

      alert('Product added');
      f.reset();
      adminModal.classList.add('hidden');
    } catch(err){
      console.error(err);
      alert('Save failed: ' + err.message);
    } finally {
      f.querySelector('button[type="submit"]').textContent = 'Save product'; f.querySelector('button[type="submit"]').disabled = false;
    }
  });

  // search & sort
  document.getElementById('search').addEventListener('input', (e)=>{
    const q = e.target.value.toLowerCase().trim();
    renderProducts(products.filter(p => p.title.toLowerCase().includes(q)));
  });
  document.getElementById('sort').addEventListener('change', (e)=>{
    const v = e.target.value;
    let res = products.slice();
    if(v==='price-asc') res.sort((a,b)=>a.price-b.price);
    if(v==='price-desc') res.sort((a,b)=>b.price-a.price);
    renderProducts(res);
  });

  // util escape
  function escapeHtml(str){ return String(str||'').replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[s]); }

  </script>
</body>
                   </html>
